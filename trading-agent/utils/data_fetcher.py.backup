"""
Data fetching utilities for historical and live market data
"""
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
from typing import List, Dict
from alpaca.data.historical import StockHistoricalDataClient
from alpaca.data.requests import StockBarsRequest
from alpaca.data.timeframe import TimeFrame
from utils.config import Config

class DataFetcher:
    """Fetch market data from various sources"""
    
    def __init__(self):
        self.alpaca_data_client = None
        if Config.ALPACA_API_KEY:
            self.alpaca_data_client = StockHistoricalDataClient(
                Config.ALPACA_API_KEY,
                Config.ALPACA_SECRET_KEY
            )
    
    def get_historical_data(
        self, 
        symbols: List[str], 
        start_date: str, 
        end_date: str,
        interval: str = "1d"
    ) -> Dict[str, pd.DataFrame]:
        """
        Get historical data using yfinance (free)
        
        Args:
            symbols: List of stock symbols
            start_date: Start date (YYYY-MM-DD)
            end_date: End date (YYYY-MM-DD)
            interval: Data interval (1d, 1h, etc.)
        
        Returns:
            Dictionary mapping symbol to DataFrame
        """
        data = {}
        
        for symbol in symbols:
            try:
                print(f"Fetching {symbol}...")
                ticker = yf.Ticker(symbol)
                df = ticker.history(start=start_date, end=end_date, interval=interval)
                
                if not df.empty:
                    # Standardize column names
                    df.columns = [col.lower() for col in df.columns]
                    data[symbol] = df
                    print(f"âœ… {symbol}: {len(df)} bars")
                else:
                    print(f"âš ï¸  {symbol}: No data")
                    
            except Exception as e:
                print(f"âŒ Error fetching {symbol}: {e}")
        
        return data
    
    def get_latest_price(self, symbol: str) -> float:
        """Get latest price for a symbol"""
        try:
            ticker = yf.Ticker(symbol)
            data = ticker.history(period="1d")
            if not data.empty:
                return data['Close'].iloc[-1]
        except Exception as e:
            print(f"Error getting price for {symbol}: {e}")
        return None
    
    def get_latest_bars(self, symbols: List[str], days: int = 30) -> Dict[str, pd.DataFrame]:
        """
        Get recent bars for multiple symbols
        
        Args:
            symbols: List of stock symbols
            days: Number of days to fetch
        
        Returns:
            Dictionary mapping symbol to DataFrame
        """
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        return self.get_historical_data(
            symbols,
            start_date.strftime("%Y-%m-%d"),
            end_date.strftime("%Y-%m-%d"),
            "1d"
        )
    
    def calculate_returns(self, df: pd.DataFrame) -> pd.Series:
        """Calculate daily returns"""
        return df['close'].pct_change()
    
    def calculate_volatility(self, df: pd.DataFrame, window: int = 20) -> float:
        """Calculate rolling volatility"""
        returns = self.calculate_returns(df)
        return returns.rolling(window=window).std().iloc[-1]
    
    def get_market_data_summary(self, symbol: str, df: pd.DataFrame) -> Dict:
        """Get summary statistics for a symbol"""
        if df.empty:
            return None
        
        latest = df.iloc[-1]
        returns = self.calculate_returns(df)
        volatility = self.calculate_volatility(df)
        
        return {
            'symbol': symbol,
            'latest_price': latest['close'],
            'latest_volume': latest['volume'],
            'daily_return': returns.iloc[-1] if len(returns) > 0 else 0,
            'volatility': volatility,
            'avg_volume': df['volume'].tail(20).mean(),
            'high_52w': df['high'].tail(252).max() if len(df) > 252 else df['high'].max(),
            'low_52w': df['low'].tail(252).min() if len(df) > 252 else df['low'].min(),
        }


if __name__ == "__main__":
    # Test the data fetcher
    fetcher = DataFetcher()
    
    print("\nğŸ” Testing Data Fetcher...\n")
    
    # Get recent data for test symbols
    symbols = ['TSLA', 'NVDA']
    data = fetcher.get_latest_bars(symbols, days=30)
    
    for symbol, df in data.items():
        print(f"\n{symbol}:")
        print(df.tail(3))
        
        summary = fetcher.get_market_data_summary(symbol, df)
        if summary:
            print(f"\nSummary:")
            print(f"  Latest Price: ${summary['latest_price']:.2f}")
            print(f"  Daily Return: {summary['daily_return']*100:.2f}%")
            print(f"  Volatility: {summary['volatility']*100:.2f}%")
